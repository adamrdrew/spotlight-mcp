phase:
  id: "0004"
  slug: polish-and-harden
  title: "Polish and Harden"
  status: complete

steps:
  - id: S001
    title: "Add Server Instructions"
    implemented: true
    reviewed: true
    notes: "Added instructions field to Server initialization describing all four tools and their purposes. Build verified successful."
    touched:
      - "Sources/SpotlightMCP/main.swift"

  - id: S002
    title: "Add swift-log Dependency"
    implemented: true
    reviewed: true
    notes: "Added swift-log dependency to Package.swift. Import verified successful."
    touched:
      - "Package.swift"
      - "Sources/SpotlightMCP/main.swift"

  - id: S003
    title: "Implement Input Validation"
    implemented: true
    reviewed: true
    notes: "Added requireAbsolutePath validation method to ArgumentParser. Updated all tools to validate paths are absolute. Enhanced kind validation with list of valid kinds. Limit clamping already implemented in PaginationConfig. Empty query strings already rejected by requireString."
    touched:
      - "Sources/SpotlightMCP/Tools/ArgumentParser.swift"
      - "Sources/SpotlightMCP/Search/KindMapping.swift"
      - "Sources/SpotlightMCP/Tools/SearchTool.swift"
      - "Sources/SpotlightMCP/Tools/SearchByKindTool.swift"
      - "Sources/SpotlightMCP/Tools/RecentFilesTool.swift"
      - "Sources/SpotlightMCP/Tools/GetMetadataTool.swift"

  - id: S004
    title: "Implement Path Sanitization"
    implemented: true
    reviewed: true
    notes: "Created PathSanitizer type that resolves symbolic links, normalizes paths, and validates scope boundaries. Added requireValidatedScope to ArgumentParser. Updated all search tools to use validated scopes."
    touched:
      - "Sources/SpotlightMCP/Tools/PathSanitizer.swift"
      - "Sources/SpotlightMCP/Tools/ArgumentParser.swift"
      - "Sources/SpotlightMCP/Tools/SearchTool.swift"
      - "Sources/SpotlightMCP/Tools/SearchByKindTool.swift"
      - "Sources/SpotlightMCP/Tools/RecentFilesTool.swift"

  - id: S005
    title: "Handle Spotlight Edge Cases"
    implemented: true
    reviewed: true
    notes: "Verified edge cases already handled correctly: zero-result queries return empty array (SpotlightQuery:72-73), unexpected metadata types return nil and are filtered (MetadataItem:89,103,108), scope directory validation added via PathSanitizer in S004. No code changes needed."
    touched: []

  - id: S006
    title: "Add Structured Logging"
    implemented: true
    reviewed: true
    notes: "Injected Logger into ToolRouter. Added server lifecycle logging (info level) in main.swift. Added tool invocation logging (debug level) and error logging (warning for validation, error for execution failures). Complies with L08 - no search results or file metadata logged."
    touched:
      - "Sources/SpotlightMCP/main.swift"
      - "Sources/SpotlightMCP/Tools/ToolRouter.swift"

  - id: S007
    title: "Test Input Validation"
    implemented: true
    reviewed: true
    notes: "Added tests for requireAbsolutePath and requireValidatedScope in ArgumentParserTests. Verified kind validation test exists in SearchByKindToolTests. Limit clamping already tested in PaginationConfigTests. All 84 tests pass."
    touched:
      - "Tests/SpotlightMCPTests/Tools/ArgumentParserTests.swift"
      - "Tests/SpotlightMCPTests/Tools/SearchByKindToolTests.swift"
      - "Tests/SpotlightMCPTests/Tools/ToolRouterTests.swift"

  - id: S008
    title: "Test Path Sanitization"
    implemented: true
    reviewed: true
    notes: "Created PathSanitizerTests with tests for path resolution, symbolic link handling, scope validation, and boundary enforcement. All 6 tests pass."
    touched:
      - "Tests/SpotlightMCPTests/Tools/PathSanitizerTests.swift"

  - id: S009
    title: "Test Edge Case Handling"
    implemented: true
    reviewed: true
    notes: "Verified edge case handling already tested: zero-result queries tested in ResultFormatterTests ('format empty results produces empty array'), metadata extraction tested in SpotlightQueryTests ('MetadataItem extracts attributes from results'), scope validation tested in SpotlightQueryTests ('execute throws on empty scope') and PathSanitizerTests. No additional tests needed."
    touched: []

  - id: S010
    title: "Test with Claude Desktop"
    implemented: true
    reviewed: true
    notes: "Release binary built at .build/release/spotlight-mcp (2.9MB). Manual testing deferred to user acceptance - automated test suite provides 90 comprehensive tests covering all tools, validation, error handling, and edge cases. Configuration snippet documented in README (S011)."
    touched: []

  - id: S011
    title: "Write README.md"
    implemented: true
    reviewed: true
    notes: "Enhanced existing README with comprehensive sections: tool reference with parameters, security model including path sanitization and input validation, troubleshooting section with common errors, updated test count to 90, added PathSanitizer to project structure, added swift-log to technical details."
    touched:
      - "README.md"

  - id: S012
    title: "Reconcile Documentation"
    implemented: true
    reviewed: true
    notes: "Updated tool-layer.md to reflect: logging in ToolRouter, ArgumentParser validation methods (requireAbsolutePath, requireValidatedScope), PathSanitizer component, enhanced SearchByKindTool error messages, updated Law Compliance table for L07 and L08, updated test coverage table. search-module.md unchanged (no changes in Search layer)."
    touched:
      - ".ushabti/docs/tool-layer.md"

  - id: S013
    title: "Final Testing"
    implemented: true
    reviewed: true
    notes: "All 90 tests pass (up from 79). Release binary builds successfully (2.9MB Mach-O arm64). Server ready for production use."
    touched: []

  - id: S014
    title: "Fix Sandi Metz Violations in Search Module"
    implemented: true
    reviewed: true
    notes: "Refactored Types.swift (was 116 lines, now 22 lines) by extracting MetadataValue Codable conformance to MetadataValue+Codable.swift (97 lines). SpotlightQuery.swift and MetadataItem.swift were already under 100 lines (93 and 92 respectively). All 90 tests pass after refactoring."
    touched:
      - "Sources/SpotlightMCP/Search/Types.swift"
      - "Sources/SpotlightMCP/Search/MetadataValue+Codable.swift"

  - id: S015
    title: "Document Manual Testing or Defer"
    implemented: true
    reviewed: true
    notes: "Manual testing explicitly deferred with justification in S010 notes. Automated test suite provides comprehensive coverage (90 tests covering all tools, validation, path sanitization, edge cases). Manual testing against Claude Desktop client deferred to user acceptance phase."
    touched:
      - ".ushabti/phases/0004-polish-and-harden/progress.yaml"
